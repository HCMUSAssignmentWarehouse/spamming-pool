<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Directions service</title>
<!--       <link rel="stylesheet" type="text/css" href="css/style.css">
 -->
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
        width: 60%;
        float: right;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #floating-panel {
        position: absolute;
        top: 10px;
        left: 25%;
        z-index: 5;
        background-color: #fff;
        padding: 5px;
        border: 1px solid #999;
        text-align: center;
        font-family: 'Roboto','sans-serif';
        line-height: 30px;
        padding-left: 10px;
      }
    </style>
  </head>
  <body>

     
 <div>
  <ul id="ul-list">
    
  </ul>
</div>

    <div id="map"></div>

    <script src="js/jquery.min.js"></script>
<script src="assests/jquery-3.1.1.min.js"></script>
 

    <script src="https://www.gstatic.com/firebasejs/4.6.1/firebase.js"></script>
    <script>
              // Initialize Firebase
        var config = {
            apiKey: "AIzaSyCPsM92WXpL9n_APrHNbO0CtkT_FbAcuBY",
            authDomain: "barg-midterm.firebaseapp.com",
            databaseURL: "https://barg-midterm.firebaseio.com",
            projectId: "barg-midterm",
            storageBucket: "barg-midterm.appspot.com",
            messagingSenderId: "263139149669"
        };
        firebase.initializeApp(config);
    </script>
    <script type="text/javascript">
       // function test() {

            var database = firebase.database().ref('book-list');

            var setMessage = function (data) {
                var val = data.val();
                alert(val.address);
            }

            database.on('child_added', function (data) {
               
                var c = data.val();
                var li = '<li onclick="getDetail(this);"><img src="images/point-icon.png"/><p style="display: none" class="key">'+data.key+'</p><h3 >Address: <p class="address"  style="display:inline">'+c.address+'</p></h3>';

                  if (c.lat != null){
                    li += '<p style="display:inline">Lat: <p style="display:inline">'+c.lat+'</p></p>'+'<p>Long: '+c.long+'</p></p>'; 
                  } 

                  li += '<p style="display:inline">Vehicle type: <p style="display:inline">'+c.vehicle+'</p></p>'
          +  '<p style="display:inline">State: <p style="display:inline"><strong>'+c.state+'</strong></p></p>'
          +  '<p style="display:inline">PhoneNumber: <p style="display:inline">'+c.phoneNumber+'<p></p>'
          +  '<p style="display:inline">Note: <p style="display:inline">'+c.note+'<p></p>'; 
          if (c.driverAddress != null){
            li += '<h3>Driver information</h3><p style="display:inline">Driver address: <p style="display:inline" class="driverAddress">'
            +c.driverAddress+'</p></p><p style="display:inline">Driver name: <p style="display:inline">'
            +c.driverName+'</p></p><p style="display:inline">Driver phone number: <p style="display:inline">'
            +c.driverPhone+'</p></p></li>';
          }

                $('#ul-list').append(li);             
               
            });
    </script>



    <script>


      function getDetail(item){
    $('li').removeClass('highlight_stay');
     $(item).addClass('highlight_stay');

    //alert($(item).find(".address").text());
    //alert($(item).find(".driverAddress").text());
    var customerAddress = $(item).find(".address").text();
    var driverAddress = $(item).find(".driverAddress").text();

    var count = item.childElementCount;
    if (count < 12){
      alert("This point haven't been process yet or not enough information to continue!");
    }else{
      // var i = 0 ;
      // var childs = item.parentNode.childNodes;
      //   for (; i < childs.length; i++) {
      //     if (item == childs[i]) break;
      //   }
      //   $.ajax({
      //  url: `http://localhost:3003/getSelectedIndex?index=${i-1}`,
      //  dataType: 'json',
      //  timeout: 10000
      // }).done(function(data){
      //  alert("zo");
      //  initMap(customerAddress, driverAddress); 
      // }).fail(function(jqXHR, textStatus, error){
      //  console.log(textStatus);
      //  console.log(error);
      //  console.log(jqXHR);
      // });

      initMap(customerAddress, driverAddress); 
    }
    
  }
      function initMap() {
        var directionsService = new google.maps.DirectionsService;
        var directionsDisplay = new google.maps.DirectionsRenderer;
        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 8,
          center: {lat: 10.762698, lng: 106.682537}
        });
        directionsDisplay.setMap(map);

        var onChangeHandler = function() {
          calculateAndDisplayRoute(directionsService, directionsDisplay);
        };
        document.getElementById('start').addEventListener('change', onChangeHandler);
        document.getElementById('end').addEventListener('change', onChangeHandler);
      }

      function calculateAndDisplayRoute(directionsService, directionsDisplay) {
        directionsService.route({
          origin: document.getElementById('start').value,
          destination: document.getElementById('end').value,
          optimizeWaypoints: true,
          travelMode: 'DRIVING'
        }, function(response, status) {
          if (status === 'OK') {
            directionsDisplay.setDirections(response);
          } else {
            window.alert('Directions request failed due to ' + status);
          }
        });
      }
    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAM0uiCd8v3-ef9qhPzZuOgWTPZON_SZvM&callback=initMap">
    </script>
  </body>
</html>